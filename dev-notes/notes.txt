

market taker
    - taker source
    - taker destination
market maker
    - maker source
    - maker destination
mint / program
    - a -> taker source -> maker destination
    - b -> maker source -> taker destination

INSTRUCTIONS:
-- USER
:: ExecutionMarketOrder 
    :: INPUT
        - type:                 Order{Buy, Sell},
        - fill:                 Fill{Partial(target_price), Full}
        - target:               Order{Source, Destination}
        - target_amount:        u64,
    :: ACCOUNTS
        - config                []
        - market_pointer        [w]
        - signer                [s, w]
        - taker_source          []
        - taker_destination     []  -- could there be a vulnerbility if I don't check owner?
        - taker_stats           []
        - order_position        []  -- maybe last order position, apply validations
        - next_order_position   []  -- optional if order position ptr is None
    :: VALIDATIONS
        - market_pointer.config == config,
        - market_pointer.is_avialable || market_pointer.state.slot_delta() >= slot_target_delta
        - taker_source.owner == signer || taker_source.delegate == signer
        - taker_stats.owner == signer
        - taker_destination.owner == signer
        - if -> (target == Source && taker_source.amount >= target_amount)
        - if -> fill == Partial 
            && ((type == Sell && order_position.price >= target_price) || (type == Buy && order_position.price <= target_price))
            -> ensure have correct order_position
    :: PROCESS
        - market_pointer [state]
            - is_avialable = false
            - slot = latest_slot
            - position.current = signer
            - posiiton.order_type = order_type
            - position.fill = fill
            - position.target = target
            - posiiton.target_amount = target_amount
            - posiiton.source = taker_source
            - posiiton.destination = taker_destination

-- USER 
:: ReturnExcutionMarketOrder
    :: ACCOUNTS
        - config                []
        - market pointer        [w]
        - signer                [s, w]
    :: VALIDATIONS
        - market_pointer.config == config,
        - maker_pointer.is_executing() == true,
        - market_pointer.current == signer,
    :: PROCESS
        - market_pointer [state] --> clear state
            - is_avialable = true
            - slot = latest_slot
            - position = None

-- USER
:: FillOrderPosition
    :: ACCOUNTS
        - config                    []
        - signer                    [s,w]
        - token_program_a           []
        - token_program_b           []
        - token_mint_a              []
        - token_mint_b              []
        - taker_source              [w]   
        - maker_destination         [w]   
        - maker_source              [w]
        - taker_destination         [w]   
        - market_pointer            [w]
        - order_position            [w]
        //- taker_stats               [w]
        - fee_collector             [w]
    :: VALIDATIONS
        - market_pointer.config == config
        - market_pointer.current == signer
        - market_pointer.ptr == order_position
        - market_pointer.source == taker_source
        - market_pointer.destination == taker_destination
        - order_position.config == config
        - order_position.source == maker_source
        - order_position.destination = maker_destination
        - config.token_mint_a == token_mint_a
        - config.token_mint_b == token_mint_b
        - config.token_program_a == token_program_a
        - config.token_program_b == token_program_b
        - config.fee_account == fee_collector
        //- taker_stats.owner == signer
    :: PROCESS
        - compute amount
        - compute fee
        - transfer amount + fee     -> taker_source -> maker_destination
        - transfer amount           -> maker_source -> taker_destination
        - transfer fee              -> taker_source -> fee_vault
        - market_pointer [state]
            - ptr = order_position.next_order_position

-- ADMIN
:: CreateTradePair
    ::INPUT
        - set_quote:        bool,
    :: ACCOUNTS
        - authority | administrator     [s],
        - config                        [w],    -> create
        - token_program_a               []
        - token_program_b               []
        - token_mint_a                  []
        - token_mint_b                  []
        - fee_account_a                 [] 
        - fee_account_b                 []
        - system_program                []
    :: VALIDATIONS
        - authority == AUTH_ID
        - config.owner == authority
        - token_mint_a < token_mint_b
        - token_mint_a.owner == token_program_a
        - token_mint_b.owner == token_program_b
        - fee_account_a.token_mint == token_mint_a
        - fee_account_b.token_mint == token_mint_b
    :: PROCESS
        - create account
        - assign as config
        - config [state]
            - token_program_a
            - token_program_b
            - token_mint_a
            - token_mint_b
            - fee_account_a
            - fee_account_b

-- ADMIN
:: CreateMarketPointer
    :: INPUTS 
        - type:         Order{Buy, Sell},
    :: ACCOUNTS
        - config                        []
        - market pointer                [w]        
        - authority / signer / payer    [s, w]
        - system_program                []
    :: VALIDATIONS
        - config.owner == authority
    :: PROCESS
        - market_pointer [state]
            -

-- USER
:: CreateOrderEscrow [source, destination]
    :: ACCOUNTS
        - config
        - order_escrow
        - token_mint
        - signer
        - system program
    :: VALIDATIONS
        - config.token_mint_a == token_mint || config.token_mint_b == token_mint
    :: PROCESS
        - create account
        - assing as token account

-- USER
:: CreateOrderPosition
    :: INPUT
        - order type:           Order{Buy, Sell},
        - price:                u64,
        - amount:               u64,
    :: ACCOUNTS
        - config                []
        - signer / payer        [s,w]
        - system program        []
        - token program a       []
        - token program b       []
        - token mint a          []
        - token mint b          []
        - capital_source        [w] -> owner == signer
        - order position        [w] -> create
        - source                [w] -> transfer -> from capital_source
        - destination           []
    :: PROCESS
        - order_position [state]
            - source = source
            - destination = destination
            - price = price
            - amount = amount
            - order_type = order_type
        - transfer
            - amount => capital_source -> source

-- USER
:: OpenOrderPosition
    :: ACCOUNTS
        - config                []
        - market pointer        [w], []
        - prev order position   [w], optional
        - next order position   [w], optional
        - order position        [w]
        - signer / payer        [s, w]
    :: VALIDATIONS
        - market_pointer.config == config
        - order_position.config == config
        - prev_order_postion != None 
            && (order_position.price )

-- USER
:: UpdateOrderPosition
    :: INPUT
        - amount:   u64,
        - price:    u64,
    :: ACCOUNTS
        - market pointer            [w], []
        - old prev order position   [w], optional
        - old next order position   [w], optional
        - new prev order position   [w], optional
        - new next order position   [w], optional
        - order position            [w]
        - signer / payer            [s,w]
        - config                    []

-- USER
:: CloseOrderPosition
    :: ACCOUNTS
        - market pointer        [w] | []
        - prev order position   [w], optional
        - next order position   [w], optional
        - order position        [w]
        - signer / payer        [s,w]
        - config                []

-- USER
:: CreateUserOrderPositionConfig
    :: ACCOUNTS
        - config                []
        - signer                [s]
        - order_config          [w]



STATE ACCOUNTS:
:: Config:
    :: SEED 
        - "config"
        - token_mint_a
        - token_mint_b
    :: VALIDATIONS
        - token_mint_a < token_mint_b
    :: STATE
        - token_program_a:      PubKey,
        - token_program_b:      PubKey,
        - token_mint_a:         PubKey,
        - token_mint_b:         PubKey,
        - sell_market_ptr:      Option<PubKey>,
        - buy_market_ptr:       Option<PubKey>,
        - taker_fee:            u64,
        - maker_fee:            u64,
        - authority             PubKey,

:: UserOrderConfig:
    :: SEED
        - signer
        - config
        - "user-order-config"
    :: CHEKCS
        - owner == signer
    :: METHODS
        - nonce += 1
    :: STATE
        - config:   PubKey
        - owner:    PubKey,
        - nonce:    u64,

:: OrderPosition
    :: SEED
        - config
        - signer
        - "order-position"
        - order_config.nonce
    :: VALIDATIONS
        - order_config.owner == signer
        - order_config.config == config
    :: STATE
        - config_autority:      PubKey,
        - type:                 Order{Buy, Sell},
        - price:                u64,
        - aount:                u64,
        - is_avialable:         bool,
        - next_order_position:  Option<OrderPositionPubkey>,
        - timestamp:            u64,
        - slot:                 u64,
        - source:               TokenAccount,
        - destination:          TokenAccount,

:: MarketPointer:
    :: SEED 
        - 
    :: STATE
        - config_autority:      PubKey,
        - type:                 Order{Buy, Sell},
        - ptr:                  Option<OrderPositionPubkey>,
        - timestamp:            u64,
        - slot:                 u64,
        - is_executing:         bool,
        - current_executer:     Option<Pubkey>,
        - fill_order:           Option<ExecuteMarketOrder>

-> ExecuteMarketOrder
    - type:             Order{Buy, Sell},
    - fill:             Fill{Partial(target_price: u64), Full}
    - target_amount:    u64,
    - collected_amount: u64,



ESCROWS:
:: OrderEscrow
    :: SEED
        - config
        - token_mint
        - signer
        - "order-escrow"
    :: VALIDATIONS
        - config.token_mint_a == token_mint || config.token_mint_b == token_mint
    :: OWNER

:: FeeVault
    :: SEED
        - config
        - token_mint
        - "fee-vault"
    :: VALIDATIONS
        - config.token_mint_a == token_mint || config.token_mint_b == token_mint
    :: OWNER



Question::
- do I need an observer?

Notes:
- one token mint is the quote mint
- one token mint is the base mint
- right now there is no way to differaintate that
- only sorting from lower token mint to greater token mint -> a -> b
--> for now will not support multisig